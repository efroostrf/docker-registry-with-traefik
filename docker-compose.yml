# Docker Registry with Traefik Reverse Proxy
name: traefik-docker-registry

services:
  # Traefik reverse proxy
  traefik:
    image: ${TRAEFIK_IMAGE}
    container_name: traefik
    restart: unless-stopped
    command:
      # Logging
      - "--log.level=DEBUG"
      - "--accesslog=true"
      # API/Dashboard (disabled for security)
      - "--api.dashboard=false"
      # Docker provider
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=internal"
      # Entrypoints
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      # HTTP to HTTPS redirect
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      # Let's Encrypt
      - "--certificatesresolvers.letsencrypt.acme.email=${LETSENCRYPT_EMAIL}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.caserver=${LETSENCRYPT_CA_SERVER}"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
    ports:
      - 80:80
      - 443:443
    volumes:
      - ${DOCKER_SOCK}:/var/run/docker.sock:ro
      - letsencrypt_data:/letsencrypt:rw
      - ./.htpasswd:/auth/htpasswd:ro
    networks:
      - internal

  # Registry for container images
  registry:
    image: ${REGISTRY_IMAGE}
    container_name: registry
    restart: unless-stopped
    environment:
      REGISTRY_STORAGE_DELETE_ENABLED: true
      REGISTRY_STORAGE_FILESYSTEM_ROOTDIRECTORY: /var/lib/registry
      REGISTRY_HTTP_ADDR: 0.0.0.0:5100
      REGISTRY_HTTP_SECRET: ${REGISTRY_HTTP_SECRET}
      # Notify registry it's running behind a reverse proxy
      REGISTRY_HTTP_HOST: https://${DOMAIN}
      REGISTRY_HTTP_RELATIVEURLS: true
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:5100/v2/"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    volumes:
      - registry_data:/var/lib/registry:rw
    networks:
      - internal
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.registry.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.registry.entrypoints=websecure"
      - "traefik.http.routers.registry.tls.certresolver=letsencrypt"
      - "traefik.http.services.registry.loadbalancer.server.port=5100"
      # Basic auth middleware (handled by Traefik)
      - "traefik.http.middlewares.registry-auth.basicauth.usersfile=/auth/htpasswd"
      - "traefik.http.middlewares.registry-auth.basicauth.realm=Registry Realm"
      - "traefik.http.routers.registry.middlewares=registry-auth"

volumes:
  letsencrypt_data:
  registry_data:

networks:
  internal:
    name: internal
    driver: bridge

